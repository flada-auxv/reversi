#!/usr/bin/env ruby

require_relative '../lib/reversi'

class ReversiExecuter

  class SkipException < StandardError; end
  class ExitException < StandardError; end

  INPUT_FORMAT = /[a-h][1-8]/

  def initialize
    @game = Reversi::Game.new
  end

  def run
    loop do
      print_board(@game.board.search_movable_pieces_for(@game.current_turn_color))

      begin
        redo unless input = read_input
        @game.move(input)
      rescue Reversi::Game::IllegalMovementError
        help
        retry
      rescue SkipException
        @game.turn_change
        puts 'skipped!!'
        puts ''
        redo
      rescue ExitException
        puts 'exit!!'
        print_score
        break
      end

      puts ''
    end
  end


  private

  def read_input
    print '>> '

    input = readline.chomp

    case input
    when 'skip'; raise SkipException
    when 'exit', 'end'; raise ExitException
    when 'score'
      input = nil
      print_score
    when ''
      input = nil
    when !INPUT_FORMAT
      input = nil
      help
    end

    input
  end

  def help
    puts 'そこには石を置く事ができません!!'
  end

  def print_score
    puts "------------------"
    puts "black:#{@game.score_of(:black)} -- white:#{@game.score_of(:white)}"
    puts ''
  end

  def print_board(movable_pieces)
    puts "turn -> #{@game.current_turn_color}"
    puts "------------------"
    puts "  a b c d e f g h"

    sio = StringIO.new

    @game.board.board.each_with_index do |x_line, i|
      sio << "#{i+1}"

      x_line.each do |piece|
        sio << '|'
        case piece.color
        when :none; movable_pieces.map(&:location).include?(piece.location) ? sio << '○' : sio << ' '
        when :black; sio << "\e[32mb\e[m"
        when :white; sio << "\e[33mw\e[m"
        end
      end

      sio << "|\n"
    end

    puts sio.string
    puts ''
  end
end

ReversiExecuter.new.run
