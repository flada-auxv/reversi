#!/usr/bin/env ruby

require_relative '../lib/reversi'

require 'stringio'

class ReversiExecuter

  class SkipException < StandardError; end
  class ExitException < StandardError; end

  INPUT_FORMAT = /[a-h][1-8]/

  def initialize
    @game = Reversi::Game.new
  end

  def run
    loop do
      print_board

      begin
        redo unless input = read_input
        @game.move(input)
      rescue Reversi::Game::IllegalMovementError
        help
        retry
      rescue SkipException
        @game.turn_change
        puts 'skipped!!'
        puts ''
        redo
      rescue ExitException
        puts 'exit!!'
        print_score
        break
      end

      puts ''
    end
  end


  private

  def read_input
    print '>> '

    input = readline.chomp

    case input
    when 'skip'; raise SkipException
    when 'exit', 'end'; raise ExitException
    when 'score'
      input = nil
      print_score
    when !INPUT_FORMAT
      input = nil
      help
    end

    input
  end

  def help
    puts 'そこには石を置く事ができません!!'
  end

  def print_score
    puts "------------------"
    puts "black:#{@game.score_of(:black)} -- white:#{@game.score_of(:white)}"
    puts ''
  end

  def print_board
    puts "turn -> #{@game.current_turn_color}"
    puts "------------------"
    puts "  a b c d e f g h"

    puts @game.board_to_s
    puts ''
  end
end

ReversiExecuter.new.run
